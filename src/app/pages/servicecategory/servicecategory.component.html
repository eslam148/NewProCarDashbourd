<div class="container-fluid py-4 bg-light min-vh-100">
  <div class="row g-3">
    <!-- Categories Section -->
    <div class="col-12 col-md-6 mb-4">
      <div class="card shadow rounded h-100">
        <div class="card-header bg-primary text-white rounded-top d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
          <h4 class="mb-2 mb-md-0">{{ 'serviceCategory.title' | translate | async }}</h4>
          <button cButton color="light" (click)="showCategoryForm = true" *ngIf="!showCategoryForm" class="mt-2 mt-md-0 rounded-pill px-2 py-0 fs-6" aria-label="Add New Category">
            <i cIcon name="cilPlus"></i> {{ 'serviceCategory.add' | translate | async }}
          </button>
        </div>
        <div class="card-body p-4">
          <!-- Add/Edit Category Form -->
          <form [formGroup]="form" *ngIf="showCategoryForm" (ngSubmit)="submit()" class="mb-4">
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.nameAr' | translate | async }}</label>
              <input type="text" class="form-control rounded-pill" formControlName="nameAr">
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.nameEn' | translate | async }}</label>
              <input type="text" class="form-control rounded-pill" formControlName="nameEn">
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.descriptionAr' | translate | async }}</label>
              <textarea class="form-control rounded" formControlName="descriptionAr"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.descriptionEn' | translate | async }}</label>
              <textarea class="form-control rounded" formControlName="descriptionEn"></textarea>
            </div>
            <div class="d-flex flex-column flex-md-row gap-2 align-items-stretch">
              <button cButton color="primary" type="submit" [disabled]="form.invalid" class="w-100 w-md-auto rounded-pill fw-bold px-4 py-2">
                {{ isEditMode ? ('common.update' | translate | async) : ('common.add' | translate | async) }}
              </button>
              <button cButton color="secondary" type="button" (click)="cancelCategoryForm()" class="w-100 w-md-auto rounded-pill fw-bold px-4 py-2">{{ 'common.cancel' | translate | async }}</button>
            </div>
          </form>

          <!-- Categories List -->
          <div class="input-group mb-3">
            <input
              type="text"
              class="form-control"
              placeholder="ابحث عن خدمة..."
              [(ngModel)]="searchKey"
              (keyup.enter)="onSearch()"
            >
            <button class="btn btn-primary" (click)="onSearch()">بحث</button>
          </div>
          <div class="list-group list-group-flush">
            <div *ngFor="let category of (categories$ | async)"
                 class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center bg-white rounded mb-2 shadow-sm border-0 category-item-hover">
              <span *ngIf="category.id != null"
                    (click)="selectCategory(category.id)"
                    [class.selected]="selectedCategoryId === category.id"
                    style="cursor:pointer; font-weight: 500; font-size: 1.1rem;">
                {{ category.nameEn }}
              </span>
              <div class="d-flex flex-row gap-2 align-items-center justify-content-end mt-2 mt-md-0">
                <button cButton color="info" *ngIf="category.id != null" (click)="selectCategory(category.id)" class="rounded-pill px-2 py-0 fs-6" aria-label="View Subcategories">
                  <i cIcon name="cilList"></i> {{ 'serviceCategory.viewSubCategories' | translate | async }}
                </button>
                <button cButton color="primary" (click)="editCategory(category)" class="rounded-pill px-2 py-0 fs-6" aria-label="Edit Category">
                  <i cIcon name="cilPencil"></i> {{ 'common.edit' | translate | async }}
                </button>
                <button cButton color="danger" *ngIf="category.id != null" (click)="openDeleteModal(category.id)" class="rounded-pill px-2 py-0 fs-6" aria-label="Delete Category">
                  <i cIcon name="cilTrash"></i> {{ 'common.delete' | translate | async }}
                </button>
              </div>
            </div>
            <div *ngIf="(categories$ | async)?.length === 0" class="list-group-item text-center text-muted bg-white rounded shadow-sm border-0">
              {{ 'serviceCategory.empty' | translate | async }}
            </div>
          </div>

          <!-- ضع هذا الكود أسفل جدول أو قائمة الخدمات مباشرة -->
          <div class="d-flex justify-content-center mt-4">
            <c-pagination
              [activePage]="currentPage"
              [pages]="getPagesCount(totalItems$ | async)"
              [visiblePages]="5"
              (activePageChange)="onPageChange($event)">
              <c-pagination-item *cPaginationPages="let page">
                {{ page }}
              </c-pagination-item>
            </c-pagination>
          </div>
        </div>
      </div>
    </div>

    <!-- Subcategories Section -->
    <div class="col-12 col-md-6 mb-4" *ngIf="selectedCategoryId !== null">
      <div class="card shadow rounded h-100">
        <div class="card-header bg-success text-white rounded-top d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
          <h4 class="mb-2 mb-md-0">{{ 'serviceCategory.subCategories' | translate | async }}</h4>
          <button cButton color="light" (click)="showSubCategoryForm = true" *ngIf="!showSubCategoryForm" class="mt-2 mt-md-0 rounded-pill px-2 py-0 fs-6" aria-label="Add Subcategory">
            <i cIcon name="cilPlus"></i> {{ 'serviceCategory.addSubCategory' | translate | async }}
          </button>
        </div>
        <div class="card-body p-4">
          <!-- Add/Edit Subcategory Form -->
          <form [formGroup]="subCategoryForm" *ngIf="showSubCategoryForm && selectedCategoryId" (ngSubmit)="submitSubCategory()" class="mb-4">
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.nameAr' | translate | async }}</label>
              <input type="text" class="form-control rounded-pill" formControlName="nameAr">
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.nameEn' | translate | async }}</label>
              <input type="text" class="form-control rounded-pill" formControlName="nameEn">
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.descriptionAr' | translate | async }}</label>
              <textarea class="form-control rounded" formControlName="descriptionAr"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.descriptionEn' | translate | async }}</label>
              <textarea class="form-control rounded" formControlName="descriptionEn"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'serviceCategory.icon' | translate | async }}</label>
              <input type="file" (change)="onSubCategoryFileSelected($event)" accept="image/*" class="form-control">
              <div *ngIf="subCategoryIconPreview" class="mt-2 preview-container">
                <img [src]="subCategoryIconPreview" alt="Preview" class="img-thumbnail" style="max-width: 120px;">
                <button cButton color="danger" size="sm" class="mt-2 rounded-pill fw-bold px-3 py-1" (click)="removeSubCategoryIcon()">
                  <i class="cil-trash me-1"></i>
                  {{ 'serviceCategory.iconRemove' | translate | async }}
                </button>
              </div>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="fromCallCenter" formControlName="fromCallCenter">
              <label class="form-check-label" for="fromCallCenter">
                {{ 'serviceCategory.fromCallCenter' | translate | async }}
              </label>
            </div>
            <div class="d-flex flex-column flex-md-row gap-2 align-items-stretch">
              <button cButton color="success" type="submit" [disabled]="subCategoryForm.invalid" class="w-100 w-md-auto rounded-pill fw-bold px-4 py-2">
                {{ isEditSubMode ? ('common.update' | translate | async) : ('common.add' | translate | async) }}
              </button>
              <button cButton color="secondary" type="button" (click)="cancelSubCategoryForm()" class="w-100 w-md-auto rounded-pill fw-bold px-4 py-2">{{ 'common.cancel' | translate | async }}</button>
            </div>
          </form>

          <!-- Subcategories List -->
          <div class="list-group list-group-flush">
            <div *ngFor="let sub of (getSubCategories(selectedCategoryId) | async)" class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center bg-white rounded mb-2 shadow-sm border-0 subcategory-item-hover">
              <span class="fw-semibold" style="font-size: 1.1rem;">{{ sub.nameEn }}</span>
              <div class="d-flex flex-row gap-2 align-items-center justify-content-end mt-2 mt-md-0">
                <button cButton color="primary" (click)="editSubCategory(sub)" class="rounded-pill px-2 py-0 fs-6" aria-label="Edit Subcategory">
                  <i cIcon name="cilPencil"></i> {{ 'common.edit' | translate | async }}
                </button>
                <button cButton color="danger" *ngIf="sub.id != null" (click)="openDeleteSubCategoryModal(sub.id)" class="rounded-pill px-2 py-0 fs-6" aria-label="Delete Subcategory">
                  <i cIcon name="cilTrash"></i> {{ 'common.delete' | translate | async }}
                </button>
              </div>
            </div>
            <div *ngIf="(getSubCategories(selectedCategoryId) | async)?.length === 0" class="list-group-item text-center text-muted bg-white rounded shadow-sm border-0">
              {{ 'serviceCategory.noSubCategories' | translate | async }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal (keep as modal) -->
  <c-modal [visible]="isDeleteModalOpen" (visibleChange)="!$event && closeDeleteModal()" class="fade-in">
    <c-modal-header class="bg-light">
      <div class="d-flex align-items-center">
        <i class="cil-trash me-2 text-danger"></i>
        <h5 cModalTitle>{{ 'serviceCategory.deleteTitle' | translate | async }}</h5>
      </div>
      <button cButtonClose (click)="closeDeleteModal()"></button>
    </c-modal-header>
    <c-modal-body>
      <p>{{ 'serviceCategory.deleteConfirmation' | translate | async }}</p>
    </c-modal-body>
    <c-modal-footer>
      <button cButton color="secondary" (click)="closeDeleteModal()">
        {{ 'common.cancel' | translate | async }}
      </button>
      <button cButton color="danger" (click)="confirmDelete()">
        {{ 'common.delete' | translate | async }}
      </button>
    </c-modal-footer>
  </c-modal>

  <c-modal [visible]="isDeleteSubCategoryModalOpen" (visibleChange)="!$event && closeDeleteSubCategoryModal()" class="fade-in">
    <c-modal-header class="bg-light">
      <div class="d-flex align-items-center">
        <i class="cil-trash me-2 text-danger"></i>
        <h5 cModalTitle>{{ 'serviceCategory.deleteTitle' | translate | async }}</h5>
      </div>
      <button cButtonClose (click)="closeDeleteSubCategoryModal()"></button>
    </c-modal-header>
    <c-modal-body>
      <p>{{ 'serviceCategory.deleteConfirmation' | translate | async }}</p>
    </c-modal-body>
    <c-modal-footer>
      <button cButton color="secondary" (click)="closeDeleteSubCategoryModal()">
        {{ 'common.cancel' | translate | async }}
      </button>
      <button cButton color="danger" (click)="confirmDeleteSubCategory()">
        {{ 'common.delete' | translate | async }}
      </button>
    </c-modal-footer>
  </c-modal>
</div>

<style>
  .category-item-hover:hover, .subcategory-item-hover:hover {
    background: #f8f9fa !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    transition: box-shadow 0.2s, background 0.2s;
  }
</style>
